<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vendor Invoice Processor</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <style>
    :root {
      --primary-color: #008bc4;
      --background-color: #f4f4f4;
      --text-color: #000000;
      --card-bg: #ffffff;
      --dropzone-border: 2px dashed #008bc4;
      --dropzone-hover: #006a9c;
    }
    body.dark-mode {
      --background-color: #1a1a1a;
      --text-color: #f0f0f0;
      --card-bg: #2a2a2a;
      --dropzone-border: 2px dashed #008bc4;
      --dropzone-hover: #cccccc;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    .main-card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.15);
      margin: 2rem auto;
      padding: 2rem;
      max-width: 800px;
      width: 100%;
    }
    @media (max-width: 600px) {
      .main-card {
        padding: 1rem 0.5rem;
        margin: 1rem 0.25rem;
        max-width: 98vw;
      }
    }
    /* Dropzone Styles */
    .dropzone {
      border: var(--dropzone-border);
      border-radius: 4px;
      padding: 2rem;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s, background-color 0.3s;
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    .dropzone.dragover {
      background-color: var(--dropzone-hover);
      opacity: 0.1;
    }
    .dropzone p {
      margin: 0;
      font-size: 1rem;
    }
    /* File info */
    .file-info {
      margin-top: 0.5rem;
      font-size: 0.95rem;
      color: var(--text-color);
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .header { display: flex; align-items: center; justify-content: space-between; flex-wrap: nowrap; width: 100%; gap: 1rem; margin-bottom: 2rem; }
    .header img { height: 60px; width: auto; display: block; flex-shrink: 0; }
    .header h2 { flex: 1 1 0; min-width: 0; margin: 0; text-align: center; color: var(--primary-color); font-size: 1.5rem; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #theme-toggle { flex-shrink: 0; height: 40px; background: var(--primary-color); color: white; border: none; padding: 0 1rem; border-radius: 4px; font-size: 1rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; }
    @media (max-width: 600px) { .header { flex-direction: column; flex-wrap: wrap; align-items: stretch; text-align: center; gap: 0.6rem; } .header h2 { font-size: 1.2rem; white-space: normal; text-overflow: clip; } #theme-toggle { width: 100%; margin-top: 0.2rem; } .header img { margin: 0 auto; } }
    form { width: 100%; }
    label { display: block; margin-top: 1.25rem; font-weight: 500; color: var(--primary-color); font-size: 1.05rem; }
    select, input[type="submit"] { width: 100%; padding: 0.8rem; margin-top: 0.5rem; border-radius: 4px; border: 1px solid #ccc; background-color: var(--background-color); color: var(--text-color); font-size: 1rem; font-weight: 500; }
    input[type="submit"] { background-color: var(--primary-color); color: white; border: none; cursor: pointer; margin-top: 2rem; font-size: 1.1rem; font-weight: 500; }
    .auth-btn { background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.95rem; font-weight: 500; text-decoration: none; margin-right: 0.5rem; margin-bottom: 0.75rem; display: inline-block; }
    .auth-btn:hover, #theme-toggle:hover, input[type="submit"]:hover { opacity: 0.85; }
    pre { white-space: pre-wrap; word-break: break-word; font-size: 90%; }

    .auth-status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      gap: 1rem;
      flex-wrap: nowrap;
    }

    .auth-status-bar .left {
      font-weight: 500;
      white-space: nowrap;
    }

    .auth-status-bar .right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .auth-status-bar .auth-btn.small-btn {
      font-size: 0.85rem;
      padding: 4px 10px;
      margin: 0;
    }
    
    /* Dark mode styles for the new file list */
    body.dark-mode .list-group-item {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-color: #495057;
    }
  </style>
</head>
<body>
  <div class="container d-flex flex-column align-items-center justify-content-center">
    <div class="main-card w-100">
      <div class="header">
        <img id="stokes-logo" src="{{ url_for('static', filename='stokes_logo_rect.png') }}" alt="Logo" />
        <h2>Vendor Invoice Processor</h2>
        <button id="theme-toggle">Dark Mode</button>
      </div>

      {% if not session.get("user_token") %}
        <div class="auth-status-bar">
          <p><strong>Status:</strong> Not signed in</p>
          <a class="auth-btn" href="{{ url_for('sign_in') }}">Sign In</a>
        </div>
      {% else %}
        <div class="auth-status-bar">
          <div class="left">Hello, {{ session.user_name }}!</div>
          <div class="right">
            <span>Status: Signed in</span>
            <a class="auth-btn small-btn" href="{{ url_for('logout') }}">Sign Out</a>
          </div>
        </div>

        <!--
        LOGS
        -->

        <!--{% if stats and stats.total > 0 %}
        <div class="stats-preview alert alert-light text-center p-2 mb-4" role="alert" style="font-size: 0.9rem;">
          Processed: <strong>{{ stats.total }}</strong> docs | 
          AI OCR Usage: <strong>{{ stats.ocr_percent }}%</strong> | 
          Avg. Pages: <strong>{{ stats.avg_pages }}</strong>
          <a href="{{ url_for('logs') }}" class="ms-3 fw-bold">View Full Logs</a>
        </div>
        {% endif %}-->

        <form id="extract-form" action="/" method="post" enctype="multipart/form-data">
          <label for="vendor">Select Vendor:</label>
          <select name="vendor" id="vendor">
            <option value="sakata">Sakata</option>
            <option value="hm_clause">HM Clause</option>
            <option value="seminis">Seminis (LIVE)</option>
            <option value="nunhems">Nunhems</option>
          </select>

          <label for="dropzone">Upload Invoices and related PDF(s):</label>
          <div id="dropzone" class="dropzone">
            <p>Drag & Drop PDF files here, or Click to Browse</p>
            <input type="file" name="pdfs" id="pdfs" multiple accept="application/pdf" style="display:none;" />
          </div>
          <div class="file-info" id="file-info">No files chosen (max. 25 MB)</div>

          <input type="submit" value="Extract Data" />
        </form>
      {% endif %}

      {% if session.get("last_result") %}
        <h4>Last Result:</h4>
        <pre>{{ session.last_result }}</pre>
      {% endif %}
    </div>
  </div>

  <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 justify-content-center align-items-center bg-dark bg-opacity-50" style="z-index: 1050; display: none;">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loadingâ€¦</span>
    </div>
  </div>

  <script>
    // Theme toggle
    const toggleButton = document.getElementById('theme-toggle');
    const body = document.body;
    const logo = document.getElementById('stokes-logo');

    function updateLogoTheme(isDark) {
      if (!logo) return;
      logo.src = isDark
        ? "{{ url_for('static', filename='stokes_logo_rect_white.png') }}"
        : "{{ url_for('static', filename='stokes_logo_rect.png') }}";
    }

    if (localStorage.getItem('theme') === 'dark-mode') {
      body.classList.add('dark-mode');
      toggleButton.textContent = 'Light Mode';
      updateLogoTheme(true);
    }
    toggleButton.addEventListener('click', () => {
      const dark = body.classList.toggle('dark-mode');
      toggleButton.textContent = dark ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('theme', dark ? 'dark-mode' : 'light-mode');
      updateLogoTheme(dark);

      // Find all the remove file buttons currently on the page
      const closeButtons = document.querySelectorAll('.btn-close');
      
      closeButtons.forEach(btn => {
        btn.classList.toggle('btn-close-white', dark);
      });
    });

    // Dropzone & PDF handling
    const dropzone = document.getElementById('dropzone');
    const pdfInput = document.getElementById('pdfs');
    const fileInfo = document.getElementById('file-info');
    const dataTransfer = new DataTransfer();

    // Form submit loading overlay
    const form = document.getElementById('extract-form');
    const overlay = document.getElementById('loading-overlay');
    if (form && overlay) {
      form.addEventListener('submit', () => {
        overlay.style.display = 'flex';
        overlay.classList.add('d-flex');
      });
    }

    // --- Create and manage the Clear Files button ---
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'd-flex justify-content-end gap-2';
    buttonContainer.style.cssText = 'margin-top: 0.5rem; display: none;';

    const clearBtn = document.createElement('button');
    clearBtn.textContent = 'Clear Files';
    clearBtn.type = 'button';
    clearBtn.className = 'btn btn-outline-danger btn-sm';
    
    buttonContainer.appendChild(clearBtn);
    fileInfo.insertAdjacentElement('afterend', buttonContainer);

    clearBtn.addEventListener('click', () => {
      dataTransfer.items.clear();
      pdfInput.value = '';
      pdfInput.files = dataTransfer.files;
      updateFileInfo();
    });
    
    // Dropzone event listeners
    dropzone.addEventListener('click', () => pdfInput.click());
    ['dragenter', 'dragover'].forEach(evt =>
      dropzone.addEventListener(evt, e => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      })
    );
    ['dragleave', 'drop'].forEach(evt =>
      dropzone.addEventListener(evt, e => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
      })
    );

    function isDuplicate(file) {
      return Array.from(dataTransfer.files).some(existing =>
        existing.name === file.name && existing.size === file.size
      );
    }

    dropzone.addEventListener('drop', e => {
      const files = Array.from(e.dataTransfer.files).filter(f =>
        f.type === 'application/pdf' && !isDuplicate(f)
      );
      files.forEach(file => dataTransfer.items.add(file));
      pdfInput.files = dataTransfer.files;
      updateFileInfo();
    });

    pdfInput.addEventListener('change', function () {
      Array.from(this.files).forEach(file => {
        if (file.type === 'application/pdf' && !isDuplicate(file)) {
          dataTransfer.items.add(file);
        }
      });
      pdfInput.files = dataTransfer.files;
      updateFileInfo();
    });

    function updateFileInfo() {
      const fileListContainer = document.getElementById('file-info');
      const files = Array.from(dataTransfer.files);

      fileListContainer.innerHTML = '';

      if (files.length === 0) {
        fileListContainer.textContent = 'No files chosen (max. 25 MB)';
        buttonContainer.style.display = 'none';
      } else {
        const list = document.createElement('ul');
        list.className = 'list-group mt-2';

        files.forEach((file, index) => {
          const listItem = document.createElement('li');
          listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

          const fileNameSpan = document.createElement('span');
          fileNameSpan.textContent = file.name;
          
          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn-close';
          deleteBtn.setAttribute('aria-label', 'Remove file');
          deleteBtn.dataset.fileIndex = index;

          if (document.body.classList.contains('dark-mode')) {
            deleteBtn.classList.add('btn-close-white');
          }

          deleteBtn.addEventListener('click', (e) => {
            const indexToRemove = parseInt(e.target.dataset.fileIndex, 10);
            const currentFiles = Array.from(dataTransfer.files);
            const updatedFiles = currentFiles.filter((_, i) => i !== indexToRemove);
            
            dataTransfer.items.clear();
            updatedFiles.forEach(f => dataTransfer.items.add(f));
            
            pdfInput.files = dataTransfer.files;
            updateFileInfo();
          });

          listItem.appendChild(fileNameSpan);
          listItem.appendChild(deleteBtn);
          list.appendChild(listItem);
        });

        fileListContainer.appendChild(list);
        buttonContainer.style.display = 'flex';
      }
    }
  </script>

</body>
</html>