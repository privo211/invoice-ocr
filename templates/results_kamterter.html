<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kamterter: Extracted Invoice Data</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    :root {
      --primary-color: #0099d8;
      --background-color: #f4f4f4;
      --text-color: #000000;
      --card-bg: #ffffff;
    }
    body.dark-mode {
       --background-color: #1e1e1e;
      --text-color: #f0f0f0;
      --card-bg: #2a2a2a;
    }
    body {
      font-family: Segoe UI, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      padding: 2em;
    }
    .text-muted {
      font-size: 1.25rem;
      text-align: center;
      color: var(--text-color);
    }
    body.dark-mode .text-muted {
      color: #f0f0f0 !important;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }
    .header h2 {
      color: var(--primary-color);
      margin: 0;
      font-size: 1.7em;
    }
    .btn-theme, .btn-back {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.6em 1em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      text-decoration: none;
    }
    .btn-theme:hover, .btn-back:hover {
      opacity: 0.9;
    }
    .btn-auth {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.6em 1em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      text-decoration: none;
    }
    .btn-auth:hover {
      opacity: 0.9;
    }
    
    /* Card Styles */
    .card { 
      background-color: var(--card-bg);
      border: none; 
      box-shadow: 0 0 8px rgba(0,0,0,0.1); 
      margin-bottom: 2rem; 
      border-radius: 8px;
    }
    
    /* Table Styles - Adjusted for Dark Mode Compatibility */
    .table {
      color: var(--text-color);
      border-color: #dee2e6;
      --bs-table-bg: transparent; /* Essential for inheriting card background */
    }
    .table th { 
      background-color: var(--primary-color); 
      color: white; 
      border-bottom: none;
    }
    .table td {
      color: var(--text-color);
      border-bottom-color: inherit;
    }
    
    /* Dark mode table adjustments */
    body.dark-mode .table {
      border-color: #495057;
    }
    body.dark-mode .table-hover tbody tr:hover {
      color: var(--text-color);
      background-color: rgba(255,255,255,0.075);
    }

    /* GL Row Styling */
    .gl-row { 
      background-color: #fff3cd !important; 
      color: #000 !important; /* Always black text on light yellow in Light Mode */
      font-weight: bold;
    } 
    
    body.dark-mode .gl-row {
      background-color: #4d4d00 !important; /* Dark olive/yellow for Dark Mode */
      color: #fff !important; /* White text for readability */
    }
    
    /* Ensure cells inside GL row inherit the row colors */
    .gl-row td {
        background-color: inherit !important;
        color: inherit !important;
    }
  </style>
</head>
<body>

  <div class="header container-fluid">
    <div class="d-flex align-items-center">
      <img id="stokes-logo" src="{{ url_for('static', filename='stokes_logo_rect.png') }}" alt="Stokes Logo" style="max-height: 50px; margin-right: 1rem;">
      <h2 class="m-0">Kamterter: Extracted Invoice Data</h2>
    </div>
    <div class="auth-section">
      <button id="theme-toggle" class="btn-theme me-2">Dark Mode</button>
      <a href="/" class="btn-back me-2">Go Back</a>
      {% if session.get("user_name") %}
        <span style="color: var(--text-color); margin-right: 0.5rem;">Hi, {{ session.user_name }}</span>
        <a href="{{ url_for('logout') }}" class="btn-auth">Sign Out</a>
      {% else %}
        <a href="{{ url_for('sign_in') }}" class="btn-auth">Sign In</a>
      {% endif %}
    </div>
  </div>

  <div class="container">
    {% if items %}
      {% for filename, lines in items.items() %}
        <div class="card p-3" id="card-{{ loop.index }}">
          <h4>üìÑ {{ filename }}</h4>
          <div class="row mb-3">
            <div class="col-md-3"><strong>Invoice #:</strong> <span id="inv-{{ loop.index }}">{{ lines[0].VendorInvoiceNo }}</span></div>
            <div class="col-md-3"><strong>Date:</strong> <span id="date-{{ loop.index }}">{{ lines[0].DocumentDate }}</span></div>
            <div class="col-md-3"><strong>Vendor:</strong> 95257</div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>No.</th>
                  <th>Description</th>
                  <th>Quantity</th>
                  <th>Unit Cost</th>
                  <th>Line Amount</th>
                </tr>
              </thead>
              <tbody id="tbody-{{ loop.index }}">
                {% for line in lines %}
                <tr class="{% if line.Type == 'G/L Account' %}gl-row{% endif %}" 
                    data-type="{{ line.Type }}" 
                    data-no="{{ line.No }}" 
                    data-desc="{{ line.Description }}" 
                    data-qty="{{ line.Quantity }}" 
                    data-cost="{{ line.DirectUnitCost }}">
                  <td>{{ line.Type }}</td>
                  <td>{{ line.No }}</td>
                  <td>{{ line.Description }}</td>
                  <td>{{ line.Quantity }}</td>
                  <td>{{ line.DirectUnitCost }}</td>
                  <td>{{ line.LineAmount }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <button class="btn btn-success float-end create-invoice-btn" 
                  data-index="{{ loop.index }}" 
                  data-inv="{{ lines[0].VendorInvoiceNo }}"
                  data-date="{{ lines[0].DocumentDate }}">
            Create Invoice in Business Central
          </button>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">No data found.</p>
    {% endif %}
  </div>

  <script>
    // --- THEME TOGGLE LOGIC ---
    const themeBtn = document.getElementById('theme-toggle');
    const logo = document.getElementById('stokes-logo');
    
    function updateLogoTheme(isDark) {
      if(logo) {
        logo.src = isDark 
        ? "{{ url_for('static', filename='stokes_logo_rect_white.png') }}" 
        : "{{ url_for('static', filename='stokes_logo_rect.png') }}";
      }
    }

    // Apply saved theme on load
    if (localStorage.getItem('theme') === 'dark-mode') {
      document.body.classList.add('dark-mode');
      themeBtn.textContent = 'Light Mode';
      updateLogoTheme(true);
    }

    themeBtn.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark-mode');
      themeBtn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('theme', isDark ? 'dark-mode' : '');
      updateLogoTheme(isDark);
    });

    // --- INVOICE CREATION LOGIC ---
    document.querySelectorAll('.create-invoice-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if(!confirm("Create this Purchase Invoice in BC?")) return;
        
        const idx = btn.dataset.index;
        const card = document.getElementById(`card-${idx}`);
        const rows = document.querySelectorAll(`#tbody-${idx} tr`);
        
        // Build Payload
        const linesPayload = [];
        rows.forEach(row => {
          linesPayload.push({
            "Document_Type": "Invoice",
            "Type": row.dataset.type,
            "No": row.dataset.no,
            "Description": row.dataset.desc,
            "Quantity": parseFloat(row.dataset.qty),
            "Direct_Unit_Cost": parseFloat(row.dataset.cost)
          });
        });

        const payload = {
          "Document_Type": "Invoice",
          "Vendor_No": "95257",
          "Vendor_Invoice_No": btn.dataset.inv,
          "Document_Date": btn.dataset.date,
          "PurchaseLines": linesPayload
        };

        try {
          btn.disabled = true;
          btn.textContent = "Processing...";
          
          const res = await fetch('/create-purchase-invoice', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });

          if (res.redirected || res.status === 401) {
             alert('Session expired. Please sign in again.');
             window.location.href = '/sign-in';
             return;
          }

          const json = await res.json();
          if (res.ok) {
            // SUCCESS VISUALS
            card.style.border = '2px solid green';
            alert(`‚úÖ Success! Invoice Created: ${json.No}`);
            btn.textContent = "Created";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
          } else {
            // FAILURE VISUALS
            card.style.border = '2px solid red';
            alert(`‚ùå Error: ${json.message || 'Unknown error'}`);
            btn.disabled = false;
            btn.textContent = "Try Again";
          }
        } catch (e) {
          card.style.border = '2px solid red';
          alert(`‚ùå Network Error: ${e.message}`);
          btn.disabled = false;
          btn.textContent = "Try Again";
        }
      });
    });
  </script>
</body>
</html>