<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kamterter: Extracted Invoice Data</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    :root {
      --primary-color: #0099d8;
      --background-color: #f4f4f4;
      --text-color: #000000;
      --card-bg: #ffffff;
    }
    body.dark-mode {
       --background-color: #1e1e1e;
      --text-color: #f0f0f0;
      --card-bg: #2a2a2a;
    }
    body {
      font-family: Segoe UI, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      padding: 2em;
    }
    .text-muted {
      font-size: 1.25rem;
      text-align: center;
      color: var(--text-color);
    }
    body.dark-mode .text-muted {
      color: #f0f0f0 !important;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }
    .header h2 {
      color: var(--primary-color);
      margin: 0;
      font-size: 1.7em;
    }
    .btn-theme, .btn-back {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.6em 1em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      text-decoration: none;
    }
    .btn-theme:hover, .btn-back:hover {
      opacity: 0.9;
    }
    .btn-auth {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.6em 1em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      text-decoration: none;
    }
    .btn-auth:hover {
      opacity: 0.9;
    }
    
    /* Card Styles */
    .card { 
      background-color: var(--card-bg);
      color: var(--text-color);
      border: none; 
      box-shadow: 0 0 8px rgba(0,0,0,0.1); 
      margin-bottom: 2rem; 
      border-radius: 8px;
    }
    .card h4 {
        color: var(--text-color);
    }
    
    /* Table Styles */
    .table {
      color: var(--text-color);
      border-color: #dee2e6;
      --bs-table-bg: transparent; 
    }
    .table th { 
      background-color: var(--primary-color); 
      color: white; 
      border-bottom: none;
    }
    .table td {
      color: var(--text-color);
      border-bottom-color: inherit;
      vertical-align: middle; /* Aligns inputs nicely */
    }
    
    body.dark-mode .table {
      border-color: #495057;
    }
    body.dark-mode .table-hover tbody tr:hover {
      color: var(--text-color);
      background-color: rgba(255,255,255,0.075);
    }
    
    /* Warning Box for US POs */
    .alert-us-warning {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        padding: 1rem;
        border-radius: 0.25rem;
        text-align: center;
        font-weight: bold;
    }
    body.dark-mode .alert-us-warning {
        background-color: #4c1d21;
        color: #ffb3b9;
        border-color: #842029;
    }

    /* Input Styles */
    .table-input {
        min-width: 80px;
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
    }

    /* Dark mode support for inputs */
    body.dark-mode .form-control {
        background-color: #3a3a3a;
        border-color: #495057;
        color: #f0f0f0;
    }
    body.dark-mode .form-control:focus {
        background-color: #3a3a3a;
        color: #ffffff;
        border-color: var(--primary-color);
    }

  </style>
</head>
<body>

  <div class="header container-fluid">
    <div class="d-flex align-items-center">
      <img id="stokes-logo" src="{{ url_for('static', filename='stokes_logo_rect.png') }}" alt="Stokes Logo" style="max-height: 50px; margin-right: 1rem;">
      <h2 class="m-0">Kamterter: Extracted Invoice Data</h2>
    </div>
    <div class="auth-section">
      <button id="theme-toggle" class="btn-theme me-2">Dark Mode</button>
      <a href="/" class="btn-back me-2">Go Back</a>
      {% if session.get("user_name") %}
        <span style="color: var(--text-color); margin-right: 0.5rem;">Hi, {{ session.user_name }}</span>
        <a href="{{ url_for('logout') }}" class="btn-auth">Sign Out</a>
      {% else %}
        <a href="{{ url_for('sign_in') }}" class="btn-auth">Sign In</a>
      {% endif %}
    </div>
  </div>

  <div class="container">
    {% if items %}
      {% for filename, lines in items.items() %}
        <div class="card p-3" id="card-{{ loop.index }}">
          <h4>üìÑ {{ filename }}</h4>
          
          <div class="row mb-3 align-items-center">
            <div class="col-md-3"><strong>Invoice #:</strong> <span id="inv-{{ loop.index }}">{{ lines[0].VendorInvoiceNo }}</span></div>
            <div class="col-md-3"><strong>Date:</strong> <span id="date-{{ loop.index }}">{{ lines[0].DocumentDate }}</span></div>
            <div class="col-md-3"><strong>Vendor:</strong> {{ lines[0].BuyFromVendorName }}</div>
            <div class="col-md-3 text-end">
              <span id="header-status-{{ loop.index }}" class="badge bg-success fs-6" style="display: none;"></span>
            </div>
          </div>

          {% set is_us_warning = false %}
          {% if lines|length == 1 and lines[0].IsUSWarning %}
             {% set is_us_warning = true %}
          {% endif %}

          {% if is_us_warning %}
             <div class="alert-us-warning">
                {{ lines[0].Description }}
             </div>
          {% else %}
             <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th>No.</th>
                      <th>Description</th>
                      <th>Quantity</th>
                      <th>Unit Cost</th>
                      <th>Subtotal</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-{{ loop.index }}">
                    {% for line in lines %}
                    <tr data-type="{{ line.Type }}" 
                        data-no="{{ line.No }}" 
                        data-desc="{{ line.Description }}">
                      
                      <td>{{ line.Type }}</td>
                      
                      <td style="width: 15%;">
                        <input type="text" class="form-control table-input no-input" value="{{ line.No }}">
                      </td>

                      <td>{{ line.Description }}</td>

                      <td style="width: 15%;">
                        <input type="number" step="0.01" class="form-control table-input qty-input" value="{{ line.Quantity }}">
                      </td>

                      <td style="width: 15%;">
                        <input type="number" step="0.01" class="form-control table-input cost-input" value="{{ line.DirectUnitCost }}">
                      </td>

                      <td style="width: 15%;">
                        $<span class="subtotal-display">{{ "%.2f"|format(line.Quantity * line.DirectUnitCost) }}</span>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>

                  <tfoot>
                    <tr>
                      <td colspan="5" class="text-end pe-3" style="font-weight: bold;">Grand Total:</td>
                      <td style="font-weight: bold; font-size: 1.05em;">
                        {% set grand_total = namespace(value=0) %}
                        {% for line in lines %}
                          {% set grand_total.value = grand_total.value + (line.Quantity * line.DirectUnitCost) %}
                        {% endfor %}
                        $<span class="grand-total-display">{{ "%.2f"|format(grand_total.value) }}</span>
                      </td>
                    </tr>
                  </tfoot>

                </table>
             </div>
             
             <button class="btn btn-success float-end create-invoice-btn" 
                     data-index="{{ loop.index }}" 
                     data-inv="{{ lines[0].VendorInvoiceNo }}"
                     data-date="{{ lines[0].DocumentDate }}"
                     data-vendor-name="{{ lines[0].BuyFromVendorName }}"
                     data-filename="{{ filename }}">
               Create Invoice in Business Central
             </button>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">No data found.</p>
    {% endif %}
  </div>

  <script>
    // --- THEME TOGGLE LOGIC ---
    const themeBtn = document.getElementById('theme-toggle');
    const logo = document.getElementById('stokes-logo');
    
    function updateLogoTheme(isDark) {
      if(logo) {
        logo.src = isDark 
        ? "{{ url_for('static', filename='stokes_logo_rect_white.png') }}" 
        : "{{ url_for('static', filename='stokes_logo_rect.png') }}";
      }
    }

    if (localStorage.getItem('theme') === 'dark-mode') {
      document.body.classList.add('dark-mode');
      themeBtn.textContent = 'Light Mode';
      updateLogoTheme(true);
    }

    themeBtn.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark-mode');
      themeBtn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('theme', isDark ? 'dark-mode' : '');
      updateLogoTheme(isDark);
    });

    // --- LIVE SUBTOTAL & GRAND TOTAL UPDATE LOGIC ---
    document.querySelectorAll('table').forEach(table => {
      table.addEventListener('input', (e) => {
        if (e.target.classList.contains('qty-input') || e.target.classList.contains('cost-input')) {
          // 1. Update the Row's Subtotal
          const row = e.target.closest('tr');
          const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
          const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
          const subtotalDisplay = row.querySelector('.subtotal-display');
          
          if (subtotalDisplay) {
            subtotalDisplay.textContent = (qty * cost).toFixed(2);
          }

          // 2. Update the Table's Grand Total
          let newGrandTotal = 0;
          table.querySelectorAll('.subtotal-display').forEach(subElement => {
            newGrandTotal += parseFloat(subElement.textContent) || 0;
          });
          
          const grandTotalDisplay = table.querySelector('.grand-total-display');
          if (grandTotalDisplay) {
            grandTotalDisplay.textContent = newGrandTotal.toFixed(2);
          }
        }
      });
    });

    // --- SHIFT + ARROW KEY FOR $1.00 INCREMENTS ---
    document.querySelectorAll('table').forEach(table => {
      table.addEventListener('keydown', (e) => {
        if (e.target.classList.contains('qty-input') || e.target.classList.contains('cost-input')) {
          
          // Check if they are pressing Up/Down AND holding the Shift key
          if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && e.shiftKey) {
            e.preventDefault(); // Stop the default 0.01 step
            
            const currentVal = parseFloat(e.target.value) || 0;
            const direction = e.key === 'ArrowUp' ? 1 : -1; // Add 1 or subtract 1
            
            // Update the input value
            e.target.value = (currentVal + direction).toFixed(2);
            
            // Force the subtotal/grand total script to recalculate immediately
            e.target.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }
      });
    });

    // --- INVOICE CREATION LOGIC ---
    document.querySelectorAll('.create-invoice-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if(!confirm("Create this Purchase Invoice in BC?")) return;
        
        const idx = btn.dataset.index;
        const card = document.getElementById(`card-${idx}`);
        const rows = document.querySelectorAll(`#tbody-${idx} tr`);
        
        // Build Payload
        const linesPayload = [];
        rows.forEach(row => {
          // FIND THE INPUTS WITHIN THE ROW
          const noInput = row.querySelector('.no-input');
          const qtyInput = row.querySelector('.qty-input');
          const costInput = row.querySelector('.cost-input');

          linesPayload.push({
            "Document_Type": "Invoice",
            "Type": row.dataset.type,
            "No": noInput ? noInput.value.trim() : row.dataset.no,
            "Description": row.dataset.desc,
            "Quantity": parseFloat(qtyInput.value) || 0,
            "Direct_Unit_Cost": parseFloat(costInput.value) || 0
          });
        });

        const payload = {
          "Document_Type": "Invoice",
          "Buy_from_Vendor_Name": btn.dataset.vendorName,
          "Vendor_Invoice_No": btn.dataset.inv,
          "Document_Date": btn.dataset.date,
          "Filename": btn.dataset.filename,
          "PurchaseLines": linesPayload
        };

        try {
          btn.disabled = true;
          btn.textContent = "Processing...";
          
          const res = await fetch('/create-purchase-invoice', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });

          if (res.redirected || res.status === 401) {
             alert('Session expired. Please sign in again.');
             window.location.href = '/sign-in';
             return;
          }

          const json = await res.json();
          if (res.ok) {
            // 1. VISUALS: Green Border on Card
            card.style.border = '2px solid green'; 

            // 2. VISUALS: Show Success Badge in Header
            const statusBadge = document.getElementById(`header-status-${idx}`);
            if(statusBadge) {
                statusBadge.style.display = 'inline-block';
                statusBadge.textContent = `BC Purchase Invoice #: ${json.No}`;
            }

            // 3. BUTTON: Disable it
            btn.textContent = "Invoice Created";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            btn.disabled = true;

          } else {
            // FAILURE VISUALS
            card.style.border = '2px solid red';
            
            // Format the detailed error from the backend
            const errorDetails = json.details ? `\n\nBC Details: ${json.details}` : '';
            
            alert(`‚ùå Error: ${json.message || 'Unknown error'}${errorDetails}`);
            
            btn.disabled = false;
            btn.textContent = "Try Again";
          }
        } catch (e) {
          card.style.border = '2px solid red';
          alert(`‚ùå Network Error: ${e.message}`);
          btn.disabled = false;
          btn.textContent = "Try Again";
        }
      });
    });
  </script>
</body>
</html>