<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Seminis: Extracted Invoice Data (LIVE)</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    :root {
      --primary-color: #0099d8;
      --background-color: #f4f4f4;
      --text-color: #000000;
      --card-bg: #ffffff;
    }
    body.dark-mode {
       --background-color: #1e1e1e;
      --text-color: #f0f0f0;
      --card-bg: #2a2a2a;
    }
    body {
      font-family: Segoe UI, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      padding: 2em;
    }
    .text-muted {
      font-size: 1.25rem;
      text-align: center;
      color: var(--text-color);
    }
    body.dark-mode .text-muted {
      color: #f0f0f0 !important;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }
    .header h2 {
      color: var(--primary-color);
      margin: 0;
      font-size: 1.7em;
    }
    h3 {
      font-size: 1.5em;
      margin-top: 1.5em;
      margin-bottom: 0.75em;
      color: var(--text-color);
    }
    .btn-theme, .btn-back {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.6em 1em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      text-decoration: none;
    }
    .btn-theme:hover, .btn-back:hover {
      opacity: 0.9;
    }
    .row-cols-md-2 .card {
      position: relative;      
      padding-top: 2rem; 
      background-color: var(--card-bg);
      border: none;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .item-header {
      color: var(--primary-color);
      font-weight: bold;
      margin-bottom: 1rem;
      line-height: 1.2;
    }
    .analysis-header {
      color: var(--primary-color);
      font-weight: 650;
      padding-top: .5rem;
      margin-bottom: 1rem;
      line-height: 1.2;
    }
    dt {
      color: var(--text-color);
      padding-top: .5rem;
      font-weight: 600;
    }
    dd {
      margin-bottom: .5rem;
    }
    .card dl dd:last-child {
      margin-bottom: 0;
    }
    .field-box {
      padding: .5rem;
      line-height: 1.3;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    .lookup-btn {
      border-radius: 0 4px 4px 0 !important;
      padding: 0 .5rem;
      min-width: 2.1rem;
      margin-left: -1px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc !important;
      background: var(--background-color);
      color: var(--text-color) !important;
    }
    .lookup-btn:hover {
      background: var(--card-bg);
      color: #fff;
      border-color: var(--primary-color);
    }
    .input-group-sm .form-control,
    .input-group-sm .lookup-btn {
      height: calc(1.5rem + 0.75rem);
      line-height: 1.5;
    }
    /* modal sizing & centering */
    .modal-dialog {
      max-width: 60%;
      width: 45%;
      margin: 1.5rem auto;
    }
    .modal-dialog-centered {
      display: flex;
      align-items: center;
      min-height: calc(100% - 1rem);
    }
    .modal-dialog .modal-content {
      max-height: 90vh;
      overflow: hidden;
    }
    .modal-dialog .modal-content ul {
      max-height: calc(80vh - 8rem);
      overflow-y: auto;
    }
    .modal-content,
    .modal-content h4,
    .modal-content label {
      font-size: 1.1rem;
    }
    .modal-content .form-check-label {
      font-size: 1rem;
      padding-left: .25rem;
    }
    .modal-content {
      background-color: var(--card-bg) !important;
      color: var(--text-color);
      border-radius: 8px;
      box-shadow: 0 0 16px rgba(0,0,0,0.2);
    }
    .modal-content h4 {
      color: var(--primary-color);
      font-size: 1.5rem;
    }
    .lookup-ok {
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: .4em 1em;
      font-weight: bold;
    }
    .lookup-cancel {
      background: transparent;
      color: var(--text-color);
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: .4em 1em;
      font-weight: bold;
    }
    body.dark-mode .lookup-cancel {
      border: 1px solid #ccc;
    }
    body.dark-mode .form-control,
    body.dark-mode .field-box {
      background-color: var(--background-color);
      color: var(--text-color);
      border: 1px solid #ccc;
    }
    body.dark-mode input::placeholder {
      color: var(--text-color);
      opacity: 0.6;
    }

    .btn-auth {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.6em 1em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      text-decoration: none;
    }
    .btn-auth:hover {
      opacity: 0.9;
    }

    .lot-checkbox {
      position: absolute;
      top: 0.8rem;
      left: 0.8rem;
      transform: scale(1.3);
      background: var(--card-bg);
      z-index: 1;
    }
    .select-all-container {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }
    .select-all-container input {
      transform: scale(1.3);
      margin-right: 0.5rem;
    }

  </style>
</head>
<body>

  <div class="header container-fluid">
    <div class="d-flex align-items-center">
      <img id="stokes-logo" src="{{ url_for('static', filename='stokes_logo_rect.png') }}" alt="Stokes Logo" style="max-height: 50px; margin-right: 1rem;">
      <h2 class="m-0">Seminis: Extracted Invoice Data (LIVE)</h2>
    </div>
    <div class="auth-section">
      <button id="theme-toggle" class="btn-theme me-2">Dark Mode</button>
      <a href="/" class="btn-back me-2">Go Back</a>
      {% if session.get("user_name") %}
        <span style="color: var(--text-color); margin-right: 0.5rem;">Hi, {{ session.user_name }}</span>
        <a href="{{ url_for('logout') }}" class="btn-auth">Sign Out</a>
      {% else %}
        <a href="{{ url_for('sign_in') }}" class="btn-auth">Sign In</a>
      {% endif %}
    </div>
  </div>

  <div class="container">
    {% if items %}
      {% set item_counter = namespace(value=0) %}

      {% for filename, item_list in items.items() %}
        <h3>ðŸ“„ {{ filename }}   -   Vendor Invoice No.: {{ item_list[0].VendorInvoiceNo or 'N/A' }}</h3>
        <div class="row row-cols-1 row-cols-md-2 g-4">
          {% for item in item_list %}
            <!--{% set item_idx = loop.index0 %}-->
            {% set item_idx = item_counter.value %}

            <div class="col">
              <div class="card h-100 p-3" data-item-idx="{{ item_idx }}">
                <div class="item-header">{{ item.VendorItemDescription }}</div>
                <dl class="row">
                  <dt class="col-sm-4">Search Purchase Order</dt>
                  <dd class="col-sm-8">
                    <div class="field-box po-field" contenteditable="true" data-item-idx="{{ item_idx }}">{{ item.PurchaseOrder or '' }}</div>
                  </dd>

                  <!--<dt class="col-sm-4">Select BC Item No.</dt>
                  <dd class="col-sm-8">
                    <select class="field-box form-select bc-item-select" data-item-idx="{{ item_idx }}" data-field="BCItemNo">
                      {% if not item.BCOptions %}<option value="">â€” Enter a PO to see options â€”</option>{% endif %}
                      {% for opt in item.BCOptions %}
                        <option value="{{ opt.No }}" {% if item.SuggestedBCItemNo == opt.No %}selected{% endif %}>
                          {{ opt.No }} â€” {{ opt.Description }}
                        </option>
                      {% endfor %}
                      <option value="Other">Other</option>
                    </select>
                    <select id="bc-input-{{ item_idx }}" class="field-box form-select mt-1" style="{% if item.BCItemNo == 'Other' or item.BCOptions|length == 0 %}display:block;{% else %}display:none;{% endif %}">
                      
                      <option value="" {% if not item.BCItemNo or item.BCItemNo == 'Other' %}selected{% endif %}>â€” Choose an Item No. â€”</option>
                       </select>
                  </dd>-->

                  <dt class="col-sm-4">Select BC Item No.</dt>
                  <dd class="col-sm-8">
                    <select class="field-box form-select bc-item-select" data-item-idx="{{ item_idx }}" data-field="BCItemNo">
                      
                      <option value="" style="color: red; font-weight: bold;" {% if not item.SuggestedBCItemNo %}selected{% endif %}>
                        - Manually select an Item No. from the list -
                      </option>

                      {% for opt in item.BCOptions %}
                        <option value="{{ opt.No }}" {% if item.SuggestedBCItemNo == opt.No %}selected{% endif %}>
                          {{ opt.No }} â€” {{ opt.Description }}
                        </option>
                      {% endfor %}
                      
                      <option value="Other">Other</option>
                    </select>

                    <select id="bc-input-{{ item_idx }}" class="field-box form-select mt-1" style="{% if item.BCItemNo == 'Other' or item.BCOptions|length == 0 %}display:block;{% else %}display:none;{% endif %}">
                      <option value="" {% if not item.BCItemNo or item.BCItemNo == 'Other' %}selected{% endif %}>â€” Choose an Item No. â€”</option>
                    </select>
                  </dd>

                  <dt class="col-sm-4">KTT #</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="KTT" contenteditable="true"></div>
                  </dd>

                  <dt class="col-sm-4">Vendor Treatment</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="Treatment" contenteditable="true">
                      {{ item.Treatment or '' }}
                    </div>
                  </dd>

                  <dt class="col-sm-4">Treatments Description</dt>
                  <dd class="col-sm-8">
                    <div class="input-group input-group-sm">
                      <input
                        type="text"
                        id="td1-{{ item_idx }}"
                        class="form-control"
                        data-field="TreatmentsDescription"
                        value="{{ item.TreatmentsDescription or '' }}"
                      />
                      <button
                        class="btn btn-outline-secondary btn-sm lookup-btn"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#lookup-modal-1"
                        data-target-id="td1-{{ item_idx }}"
                      >â˜°</button>
                    </div>
                  </dd>

                  <dt class="col-sm-4">Treatments Description 2</dt>
                  <dd class="col-sm-8">
                    <div class="input-group input-group-sm">
                      <input
                        type="text"
                        id="td2-{{ item_idx }}"
                        class="form-control"
                        data-field="TreatmentsDescription2"
                        value="{{ item.TreatmentsDescription2 or '' }}"
                      />
                      <button
                        class="btn btn-outline-secondary btn-sm lookup-btn"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#lookup-modal-2"
                        data-target-id="td2-{{ item_idx }}"
                      >â˜°</button>
                    </div>
                  </dd>

                  <dt class="col-sm-4">Vendor Lot No.</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="VendorLotNo" contenteditable="true">
                      {{ item.VendorLot or '' }}
                    </div>
                  </dd>
                  
                  <dt class="col-sm-4">Vendor Batch No.</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="VendorBatchNo" contenteditable="true">{{ item.VendorBatch or '' }}</div>
                  </dd>
                  
                  <dt class="col-sm-4">Country of Origin</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="OriginCountry" contenteditable="true">{{ item.OriginCountry or '' }}</div>
                  </dd>

                  <dt class="col-sm-4">Package Description</dt>
                  <dd class="col-sm-8">
                    <select class="form-select field-box" data-field="PackageDescription">
                      <option value="" {% if not item.PackageDescription %}selected{% endif %}>â€” Choose a Package Description â€”</option>
                      {% for desc in pkg_descs %}<option value="{{ desc }}" {% if item.PackageDescription == desc %}selected{% endif %}>{{ desc }}</option>{% endfor %}
                    </select>
                  </dd>

                  <dt class="col-sm-4">Total Price</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="TotalPrice" contenteditable="true">
                      {{ item.TotalPrice or '' }}
                    </div>
                  </dd>

                  <dt class="col-sm-4">Original Received Qty.</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="TotalQuantity" contenteditable="true">
                      {{ item.TotalQuantity or '' }}
                    </div>
                  </dd>

                  <dt class="col-sm-4">USD Actual Cost $</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="USD_Actual_Cost_$" contenteditable="true">
                      {{ item["USD_Actual_Cost_$"] or "" }}
                    </div>
                  </dd>

                  <div class="analysis-header mt-2">Packing List Data:</div>

                  <dt class="col-sm-4">Current Germ</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="Germ" contenteditable="true">{{ item.PackingGerm or '' }}</div>
                  </dd>
                  
                  <dt class="col-sm-4">Current Germ Date</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="GermDate" contenteditable="true">{{ item.PackingGermDate or '' }}</div>
                  </dd>

                  <dt class="col-sm-4">Seed Count</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="SeedCount" contenteditable="true">
                      {{ item.SeedCountPerLB or '' }}
                    </div>
                  </dd>

                  <div class="analysis-header mt-2">Seed Analysis Report Data:</div>
                  
                  <dt class="col-sm-4">Grower Germ</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="GrowerGerm" contenteditable="true">
                      {{ item.Germ or '' }}
                    </div>
                  </dd>

                  <dt class="col-sm-4">Grower Germ Date</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="GrowerGermDate" contenteditable="true">
                      {{ item.GermDate or '' }}
                    </div>
                  </dd>

                  <dt class="col-sm-4">Purity</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="Purity" contenteditable="true">{{ item.Purity or '' }}</div>
                  </dd>
                
                  <dt class="col-sm-4">Inert</dt>
                  <dd class="col-sm-8">
                    <div class="field-box" data-field="Inert" contenteditable="true">{{ item.InertMatter or '' }}</div>
                  </dd>
                </dl>
              </div>
            </div>

            {% set item_counter.value = item_counter.value + 1 %}

          {% endfor %}
        </div>
      {% endfor %}
      <div class="text-center my-4">
        {% if session.get("user_token") %}
          <button id="create-lots-btn" class="btn btn-success btn-lg">
            Create Lots in Business Central
          </button>
        {% else %}
          <p class="text-warning">You must <a href="{{ url_for('sign_in') }}">sign in</a> before creating lots.</p>
        {% endif %}
      </div>
    {% else %}
      <p class="text-center mt-4">No data was extracted.</p>
    {% endif %}
  </div>

  <!-- Lookup Modals -->
  {% for modal_id, treatments in {1:treatments1, 2:treatments2}.items() %}
  <div class="modal fade" id="lookup-modal-{{modal_id}}" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
      <div class="modal-content p-3">
        <h4>Select Treatments</h4>
        <ul class="list-unstyled mb-3">
          {% for t in treatments %}
            <li>
              <label><input type="checkbox" value="{{t}}" /> {{t}}</label>
            </li>
          {% endfor %}
        </ul>
        <div class="text-end">
          <button type="button" class="lookup-ok" data-modal-id="{{modal_id}}">OK</button>
          <button type="button" class="lookup-cancel" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <div class="modal fade" id="lot-selection-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
      <div class="modal-content p-3">
        <h4>Select Lots to Create</h4>
        
        <div class="select-all-container">
            <input type="checkbox" id="select-all-lots" checked/>
            <label for="select-all-lots">Select/Deselect All</label>
        </div>

        <ul class="list-unstyled mb-3" id="lot-selection-list"></ul>

        <div class="text-end">
          <button type="button" class="lookup-ok" id="confirm-lot-creation-btn">Create Selected Lots</button>
          <button type="button" class="lookup-cancel" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let bcItemsCache = null;

    async function fetchBcItems() {
      if (!bcItemsCache) {
        const resp = await fetch('/api/items');
        if (!resp.ok) throw new Error('Failed to fetch BC items list');
        bcItemsCache = await resp.json();
      }
      return bcItemsCache;
    }

    async function toggleManualBcInput(selectElement) {
      const itemIdx = selectElement.dataset.itemIdx;
      const manualInput = document.getElementById(`bc-input-${itemIdx}`);
      if (!manualInput) return;

      if (selectElement.value === 'Other') {
        manualInput.style.display = 'block';
        if (!manualInput.dataset.filled) {
          try {
            const items = await fetchBcItems();
            items.forEach(item => {
              const opt = document.createElement('option');
              opt.value = item.No;
              opt.textContent = `${item.No} â€” ${item.Description}`;
              manualInput.appendChild(opt);
            });
            manualInput.dataset.filled = 'true';
          } catch (err) {
            console.error('Failed to load BC Items:', err);
          }
        }
      } else {
        manualInput.style.display = 'none';
        manualInput.value = '';
      }
    }

        /**
     * Helper function to get a numeric value from a contenteditable field.
     * Returns 0 if the field is not found or is not a valid number.
     */
    function getNumericFieldValue(cardEl, fieldName) {
      const el = cardEl.querySelector(`[data-field="${fieldName}"]`);
      if (!el) return 0; // Default to 0 for fields like upcharge/discount if not present
      
      const text = el.textContent.trim().replace(/,/g, '');
      if (text === '') return 0;
      
      const val = parseFloat(text);
      return isNaN(val) ? 0 : val;
    }

    /**
     * Recalculates the USD Actual Cost $ based on the formula:
     * (Total Price + Total Upcharge - Total Discount) / Total Quantity
     * and updates the field in the card.
     */
    function recalculateUSDCost(cardEl) {
      const price = getNumericFieldValue(cardEl, 'TotalPrice');
      const upcharge = getNumericFieldValue(cardEl, 'TotalUpcharge'); // Will be 0 if field doesn't exist
      const discount = getNumericFieldValue(cardEl, 'TotalDiscount'); // Will be 0 if field doesn't exist
      const quantity = getNumericFieldValue(cardEl, 'TotalQuantity');

      const costField = cardEl.querySelector('[data-field="USD_Actual_Cost_$"]');
      if (!costField) return; // Exit if the cost field isn't on the card

      if (quantity > 0) {
        // Apply the formula
        const cost = (price + upcharge - discount) / quantity;
        costField.textContent = cost.toFixed(4); // Match 4-decimal precision
      } else {
        costField.textContent = ''; // Clear if quantity is 0 or invalid
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      // --- THEME ---
      const themeBtn = document.getElementById('theme-toggle');
      const logo = document.getElementById('stokes-logo');
      
      const applyTheme = (isDark) => {
        document.body.classList.toggle('dark-mode', isDark);
        themeBtn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        if (logo) {
          logo.src = isDark 
          ? "{{ url_for('static', filename='stokes_logo_rect_white.png') }}" 
          : "{{ url_for('static', filename='stokes_logo_rect.png') }}";
        }
      };

      const savedThemeIsDark = localStorage.getItem('theme') === 'dark-mode';
      applyTheme(savedThemeIsDark);
      themeBtn.addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark-mode' : '');
        applyTheme(isDark);
      });

      // --- AUTOCALCULATE USD ACTUAL COST ---
      // Listen for changes on all fields that affect the cost calculation
      document.querySelectorAll(
        '[data-field="TotalPrice"],' +
        '[data-field="TotalUpcharge"],' +
        '[data-field="TotalDiscount"],' +
        '[data-field="TotalQuantity"]'
      ).forEach(field => {
        field.addEventListener('blur', (e) => {
          // Find the parent .card element for this field
          const card = e.target.closest('.card');
          if (card) {
            // Recalculate the cost for this specific card
            recalculateUSDCost(card);
          }
        });
      });

      // --- EVENT LISTENERS ---
      document.querySelectorAll('.po-field').forEach(div => {
        div.addEventListener('blur', async e => {
          const po = e.target.textContent.trim();
          const itemIdx = e.target.dataset.itemIdx;
          const select = document.querySelector(`.card[data-item-idx="${itemIdx}"] .bc-item-select`);
          if (!po || !select) return;

          select.innerHTML = '<option>Loading...</option>';
          try {
            const res = await fetch(`/bc-options?po=${encodeURIComponent(po)}`);
            if (!res.ok) throw new Error(await res.text());
            
            const opts = await res.json();
            select.innerHTML = '';

            // --- Re-add the placeholder option ---
            const placeholder = document.createElement('option');
            placeholder.value = "";
            placeholder.textContent = "- Manually select an Item No. from the list -";
            select.append(placeholder);

            opts.forEach(o => {
              const optEl = document.createElement('option');
              optEl.value = o.No;
              optEl.textContent = `${o.No} â€” ${o.Description}`;
              select.append(optEl);
            });
            
            const otherEl = document.createElement('option');
            otherEl.value = 'Other';
            otherEl.textContent = 'Other';
            select.append(otherEl);

            toggleManualBcInput(select);

          } catch (error) {
            console.error('Failed to fetch BC items:', error);
            select.innerHTML = '<option value="ERROR">Error loading items</option>';
          }
        });
      });

      // For BC Item dropdowns
      document.querySelectorAll('.bc-item-select').forEach(sel => {
        sel.addEventListener('change', () => toggleManualBcInput(sel));
        toggleManualBcInput(sel);
      });

      // For treatment lookup modals
      document.querySelectorAll('.lookup-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const modalEl = document.querySelector(btn.getAttribute('data-bs-target'));
          modalEl.dataset.targetId = btn.getAttribute('data-target-id');
          modalEl.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
        });
      });

      document.querySelectorAll('.lookup-ok').forEach(ok => {
        ok.addEventListener('click', () => {
          const modalId = ok.dataset.modalId;
          const modalEl = document.getElementById(`lookup-modal-${modalId}`);
          const targetId = modalEl.dataset.targetId;
          const inp = document.getElementById(targetId);
          const values = Array.from(modalEl.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
          inp.value = values.join(', ');
          bootstrap.Modal.getInstance(modalEl).hide();
        });
      });
    });

    function getFieldValue(cardEl, fieldName) {
      const el = cardEl.querySelector(`[data-field="${fieldName}"]`);
      if (!el) return '';
      return el.tagName === 'INPUT' || el.tagName === 'SELECT' ? el.value.trim() : el.textContent.trim();
    }

    /*document.getElementById('create-lots-btn')?.addEventListener('click', async () => {
      const cards = document.querySelectorAll('.card');
      if (cards.length === 0) return alert("No items found to create.");
      
      for (const card of cards) {
        // Prompt user to confirm creation for each lot
        const name = card.querySelector('.item-header')?.textContent.trim();
        if (!confirm(`Create this lot?\n\n${name}`)) continue;

        let bcItemNo = getFieldValue(card, 'BCItemNo');

        if (bcItemNo === 'Other') {
          const itemIdx = card.dataset.itemIdx;
          const manualInput = document.getElementById(`bc-input-${itemIdx}`);
          bcItemNo = manualInput.value.trim();
        }

        const data = {
          BCItemNo:               bcItemNo,
          TreatmentsDescription:  getFieldValue(card, 'TreatmentsDescription'),
          TreatmentsDescription2: getFieldValue(card, 'TreatmentsDescription2'),
          VendorLotNo:            getFieldValue(card, 'VendorLotNo'),
          VendorBatchLot:         getFieldValue(card, 'VendorBatchNo'),
          OriginCountry:          getFieldValue(card, 'OriginCountry'),
          CurrentGerm:            getFieldValue(card, 'Germ'),
          CurrentGermDate:        getFieldValue(card, 'GermDate'),
          SeedCount:              getFieldValue(card, 'SeedCount'),
          USD_Actual_Cost_$:      getFieldValue(card, 'USD_Actual_Cost_$'),
          GrowerGerm:             getFieldValue(card, 'GrowerGerm'),
          GrowerGermDate:         getFieldValue(card, 'GrowerGermDate'),
          Purity:                 getFieldValue(card, 'Purity'),
          Inert:                  getFieldValue(card, 'Inert'),
          PackageDescription:     getFieldValue(card, 'PackageDescription'),
          TotalQuantity:          getFieldValue(card, 'TotalQuantity'),
          TotalPrice:             getFieldValue(card, 'TotalPrice')
        };
        
        if (!data.BCItemNo || !data.VendorLotNo) {
            alert(`Skipping item. Missing BC Item No. or Vendor Lot No. for card:\n${card.querySelector('.item-header').textContent.trim()}`);
            continue;
        }

        try {
          const res = await fetch('/create-lot', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(data)
          });

          if (res.redirected || res.status === 401) {
            alert('Your session has expired. Please sign in again.');
            window.location.href = '/sign_in';
            return;
          }

          const json = await res.json();
          if (res.ok && json.status === 'success') {
            card.style.border = '2px solid green';
            alert(`âœ… Successfully created Lot for Vendor Lot: ${data.VendorLotNo}`);
          } else {
            card.style.border = '2px solid red';
            alert(`âŒ Error creating Lot for Vendor Lot ${data.VendorLotNo}:\n${json.message}`);
          }
        } catch (err) {
          card.style.border = '2px solid red';
          alert(`âŒ Network error for Vendor Lot ${data.VendorLotNo}:\n${err.message}`);
        }
      }
    });*/
    // Replace your existing 'create-lots-btn' event listener with all of this new code

    document.getElementById('create-lots-btn')?.addEventListener('click', () => {
      const cards = document.querySelectorAll('.card');
      if (cards.length === 0) return alert("No items found to create.");

      const listElement = document.getElementById('lot-selection-list');
      listElement.innerHTML = ''; // Clear previous items

      // Populate the modal with all lots from the page
      cards.forEach(card => {
        const name = card.querySelector('.item-header')?.textContent.trim() || 'Unnamed Item';
        const itemIdx = card.dataset.itemIdx;

        const listItem = document.createElement('li');
        listItem.innerHTML = `
          <label>
            <input type="checkbox" class="lot-item-checkbox" data-item-idx="${itemIdx}" checked />
            ${name}
          </label>
        `;
        listElement.appendChild(listItem);
      });
      
      // Show the modal
      const lotSelectionModal = new bootstrap.Modal(document.getElementById('lot-selection-modal'));
      lotSelectionModal.show();
    });

    // Add a new event listener for the "Select All" checkbox
    document.getElementById('select-all-lots').addEventListener('change', function(e) {
        document.querySelectorAll('#lot-selection-list .lot-item-checkbox').forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });

    // Add a new event listener for the final confirmation button inside the modal
    document.getElementById('confirm-lot-creation-btn').addEventListener('click', async () => {
      const selectedCheckboxes = document.querySelectorAll('#lot-selection-list .lot-item-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
          alert("No lots were selected. Please select at least one lot to create.");
          return;
      }
      
      // Hide the modal before processing starts
      const modalEl = document.getElementById('lot-selection-modal');
      bootstrap.Modal.getInstance(modalEl).hide();

      // Array to hold the results for the final summary
      let creationResults = [];

      for (const checkbox of selectedCheckboxes) {
        const itemIdx = checkbox.dataset.itemIdx;
        const card = document.querySelector(`.card[data-item-idx="${itemIdx}"]`);
        
        // --- This is your original processing logic, now applied only to selected items ---
        let bcItemNo = getFieldValue(card, 'BCItemNo');
        if (bcItemNo === 'Other') {
          const manualInput = document.getElementById(`bc-input-${itemIdx}`);
          bcItemNo = manualInput.value.trim();
        }

        const data = {
            vendor:                 'seminis',
            BCItemNo:               bcItemNo,
            KTT:                    getFieldValue(card, 'KTT'),
            TreatmentsDescription:  getFieldValue(card, 'TreatmentsDescription'),
            TreatmentsDescription2: getFieldValue(card, 'TreatmentsDescription2'),
            VendorLotNo:            getFieldValue(card, 'VendorLotNo'),
            VendorBatchLot:         getFieldValue(card, 'VendorBatchNo'),
            OriginCountry:          getFieldValue(card, 'OriginCountry'),
            CurrentGerm:            getFieldValue(card, 'Germ'),
            CurrentGermDate:        getFieldValue(card, 'GermDate'),
            SeedCount:              getFieldValue(card, 'SeedCount'),
            USD_Actual_Cost_$:      getFieldValue(card, 'USD_Actual_Cost_$'),
            GrowerGerm:             getFieldValue(card, 'GrowerGerm'),
            GrowerGermDate:         getFieldValue(card, 'GrowerGermDate'),
            Purity:                 getFieldValue(card, 'Purity'),
            Inert:                  getFieldValue(card, 'Inert'),
            PackageDescription:     getFieldValue(card, 'PackageDescription'),
            TotalQuantity:          getFieldValue(card, 'TotalQuantity'),
            TotalPrice:             getFieldValue(card, 'TotalPrice')
        };
        
        if (!data.BCItemNo || !data.VendorLotNo) {
            alert(`Skipping item. Missing BC Item No. or Vendor Lot No. for card:\n${card.querySelector('.item-header').textContent.trim()}`);
            continue;
        }

        try {
            const res = await fetch('/create-lot', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });

            if (res.redirected || res.status === 401) {
                alert('Your session has expired. Please sign in again.');
                window.location.href = '/sign_in';
                return;
            }

            const json = await res.json();
            if (res.ok && json.status === 'success' && json.Lot_No) {
            card.style.border = '2px solid green';
            const newLotNo = json.Lot_No;
            creationResults.push({ vendorLot: data.VendorLotNo, bcLot: newLotNo, status: 'Success' });

            // Find the definition list (<dl>) inside the card
            const dl = card.querySelector('dl');
            if (dl && !card.querySelector('.bc-lot-display')) { // Check to prevent adding duplicates
              // Create new elements to display the BC Lot No.
              const dt = document.createElement('dt');
              dt.className = 'col-sm-4 bc-lot-display'; // Add a class for the check above
              dt.textContent = 'BC Lot No.';
              dt.style.color = '#198754'; // Bootstrap success green

              const dd = document.createElement('dd');
              dd.className = 'col-sm-8';
              dd.textContent = newLotNo;
              dd.style.fontWeight = 'bold';
              dd.style.color = '#198754';

              dl.prepend(dd);
              dl.prepend(dt);
            }
          } else {
              card.style.border = '2px solid red';
              const errorMessage = json.message || 'An unknown error occurred.';
              creationResults.push({ vendorLot: data.VendorLotNo, bcLot: 'N/A', status: 'Failed', error: errorMessage });
              alert(`âŒ Error for Vendor Lot ${data.VendorLotNo}:\n${errorMessage}`);
          }
        } catch (err) {
            card.style.border = '2px solid red';
            alert(`âŒ Network error for Vendor Lot ${data.VendorLotNo}:\n${err.message}`);
        }
      }
      // Final detailed summary alert
      const successCount = creationResults.filter(r => r.status === 'Success').length;
      const failedCount = creationResults.length - successCount;
      let summaryMessage = `âœ… Processing complete.\n\nSuccess: ${successCount} | Failed: ${failedCount}\n\n`;

      summaryMessage += creationResults.map(r => {
        let line = `- Vendor Lot [${r.vendorLot}] -> BC Lot [${r.bcLot}]`;
        if (r.status === 'Failed') {
          line += ` (FAILED: ${r.error.substring(0, 100)}...)`;
        }
        return line;
      }).join('\n');
      
      alert(summaryMessage);
    });
  </script>
</body>
</html>